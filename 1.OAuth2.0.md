# OAuth 의 개념

## 간단한 개념

외부에서 개발된 소프트웨어를 이용하기 위해서는 연결을 해야한다. 연결은 API를 통해서 이루어지며, 해당 API 를 제공하기 위해서는 요청을 승인하는 방식이 필요하다. 이러한 방식 중, __로그인 하지 않고도 제3자에게 서비스를 제공할 수 있도록 권한을 부여하는 표준 프로토콜__ 이 OAuth 이다. OAuth 2.0은 개인이 자신의 데이터를 확인, 통제 및 사용할 수 있게 하는 제도인 마이데이터의 핵심 기술이다. 개인이 자신의 데이터를 활용하기 위해서는 마이데이터 서비스를 제공하는 회사에 자신의 데이터를 보낼 수 있어야 한다. 이 때 사용되는 기술 표준이 바로 OAuth 2.0 이다.  
한 가지 주의 할점은, `인증`  이 아니라 `인가` 프레임워크 이다. [공식문서](https://www.rfc-editor.org/rfc/rfc6749) 를 봐도 `Authorization Framework` 라고 표기가 되어 있다. 권한을 부여하는 행위 자체가 인증이 바탕으로 들어가 있으므로, 다른 인증시스템과 함께 활용을 한다! 헷갈리지 말아야 한다.

## 등장 배경

기존 사용자 인증 방식 중 가장 대표적인 방식은 ID 와 비밀번호로 로그인하는 방식이다. 로그인이 성공할 경우, 쿠키에 세션 값을 저장함으로써 권한이 부여되었다. 이 경우 한 번의 인증으로 세션이 비활성화될 때까지 사용자는 통제된 기능 및 자원의 접근이 가능했다. 매우 간편하고 효율적인 인증 방식이다.  
하지만, 쿠키 기반 권한 부여는 아래와 같은 단점이 존재한다.

- 일반적으로 Stateful 하다. 서버에 요청이 접수될 때마다 DB를 통해 현재 상태에 대한 확인을 해야한다. 이에 따라 서버측에서 권한의 유효성을 반복적으로 검증하는 비용이 발생하며, 권한 부여 프로세스를 앱서버로부터 분리시키기 어렵다.
- 쿠키는 보통 도메인에 속한 경우가 많다. 여러 도메인과 상호작용하는 앱의 경우, 추가적으로 설정해야 할 사항들이 생길 가능성이 높다
- 모바일 앱에 적합하지 않다
- 사용자가 서로 다른 서비스 간에 데이터 공유가 어렵다.

이러한 단점들을 해결하기 위해 IEFT(Internet Engineering Task Force)가 만들어낸 `프레임워크` 가 OAuth 2.0 이다.

## OAuth 의 네 가지 구성요소

### __1) 사용자(Resource Owner)__

서비스를 이용하려는 사람들 즉, 요청을 보내는 사용자들이다. OAuth 2.0 에서 제시하는 `리소스` 의 개념이 서버가 가지고 있는 데이터를 뜻하기 때문에 Resource Owner 라는 명칭을 가지고 있다.

### __2) 앱(Client)__

서비스를 제공하려는 응용 프로그램. 흔히 웹에서 사용하는 서버와 클라이언트를 묶어서 앱이라고 부른다. 앱이 권한 제공기관에 권한을 요청하며 OAuth2 의 절차적 흐름이 시작된다.

### __3) 권한 제공기관(Authorization Server)__

OAuth는 `토큰을 기반으로 하는 인가 프레임워크` 이다. 인증을 받은 후에 OAuth 로 부터 인가를 받으면 `Access Token` 이 발급된다. 이후 사용자가 리소스 요청 시 Header 에 Access Token 을 포함하여 데이터 제공기관에게 요청을 보내고, 데이터 제공기관에서 사용가능 한 토큰인 경우 요청을 처리하게 된다. 이 때, 필수적으로 사용되는 Access Token 을 발급하는 곳이 Authorization Server 이다.

### __4) 데이터 제공기관(Resource Server)__

단어 자체가 리소스를 가지고 있는 부분이라고 해석될 수 있으나, [Resource Server 설명 공식문서](https://www.oauth.com/oauth2-servers/the-resource-server/) 를 참고하면, 리소스 서버는 실제로 데이터를 가진 곳이 아니라 __Access Token 을 얻은 Application 의 인증받은 요청에 대하여 핸들링을 한다__ 라고 되어 있다. 여기서 어떤 것을 `핸들링` 하는 지도 아래에 나와있었다.  
```
1. Verifying Access Tokens: Access Token 확인
2. Verifying Scope: Scope 확인(Scope: 각 Client 가 가지는 리소스에 대한 권한의 범위)
3. Expired Tokens: 토큰 만료 체크
4. Error Codes and Unauthorized Access: 오류 코드 및 비인가 접근에 대한 처리
```
어디에도, 실제로 리소스를 가지고 있는 서버라는 내용이 없었다. 즉, 이름은 리소스 서버이지만 __실제 역할은 데이터에 접근하기 전 문지기에 가깝다.__

## OAuth 에서 사용되는 데이터

### 1) 앱의 등록 정보

OAuth 를 사용하기 위해서는 사전에 권한 제공기관에 앱을 등록해야 한다. 새로운 앱이 등록할 때 서비스 명칭, 웹사이트, 로고 등 앱의 기본정보를 함께 제출한다. 브라우저 기반 앱, 모바일 앱 등 몇 가지 경우는 반드시 Redirect URI 에 대한 정보를 추가해야 한다.

### 2) client_id, client_secret

카카오, 네이버에 접속할 때 ID, PW 가 필요하 듯 Client 가 권한 제공기관으로부터 인가를 받고 토큰을 받기 위해서 `Client 가 가진 고유의 ID 와 secret(PW 역할)`이 필요함

### 3) Redirect URI

Client 가 권한 제공기관에게 토큰 발행 요청 시, 권한 제공기관은 한 번 더 사용자에게 동의 여부를 물어보는데, 사용자가 동의할 시 앱에 등록된 Redirect URI 로 이동(redirection) 시킨다. 이는 두 가지 이유에서 존재한다.

1. 등록되지 않은 Redirect URI 를 담은 요청을 받게 되면 무효화 시킨다.
   - 기존에 등록된 Redirect URI 범위 내에서만 요청을 받게하여 외부 공격을 막는다.
2. 토큰 발행 요청 시 종종 브라우저를 해당 기관으로 아예 Redirect 하는 경우가 발생한다.
   - 예를 들어, 네이버 로그인을 지원해야 하는데 아예 네이버 로그인 페이지로 넘어가는 경우
   - 즉, 브라우저의 제어권을 OAuth 기관에게 넘기는 것이다.
   - 이 때, 로그인 성공 시 다시 나의 앱으로 돌아와야 하는데(브라우저의 제어권을 가져와야 하는데) 돌아오는 주소를 Redirect URI 에 담는다.

## 참고 사이트

[OAuth2.0 공식사이트](https://oauth.net/2/)  
[OAuth 2.0 Simplified](https://www.oauth.com/)  
[OAuth 2.0 소개 1부](http://www.2e.co.kr/news/articleView.html?idxno=208569)  
[[OAuth2_이론 #01] a.k.a 나는 어쩌다 인증을 하게 되었나.](https://blinders.tistory.com/63)
